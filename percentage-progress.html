<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Calculate Percentage Progress for D&D 5e XP</title>
    <style>
        body {
            background-color: lightgrey;
        }
        #progressBarWrapper {
            height: 30px;
            width: 400px;
            border: 2px black solid;
            background-color: lightgrey;
        }
        #progressBar {
            width: 0;
            height: 30px;
            background-color: purple;
        }
        .wrapperDude {
            min-width: 440px;
            max-width: 950px;
            width: calc(100% - 16px - 4em);
            min-height: calc(100vh - 16px - 4em);
            background-color: white;
            padding: 2em;
            margin-left: auto;
            margin-right: auto;
        }
    </style>
</head>
<body>
<div class="wrapperDude">

    <div>
        <label>Current XP: <input type="text" id="currentXp" min="0" /></label>
    </div>

    <div>
        <h2>Current Level: <span id="currentLevel"></span></h2>
        <h2>Next Level: <span id="nextLevel"></span></h2>
        <h2>Percentage Progress: <span id="percentageProgress"></span></h2>
    </div>

    <div id="progressBarWrapper">
        <div id="progressBar"> </div>
    </div>

    <details>
    <summary>Levels Table</summary>
    <table id="levelsTable">
        <thead><tr>
            <th><strong>Experience Points</strong></th>
            <th><strong>Level</strong></th>
            <th><strong>Proficiency Bonus</strong></th>
        </tr></thead>
        <tbody>
        <tr>
            <td>0</td>
            <td>1</td>
            <td>+2</td>
        </tr>
        <tr>
            <td>300</td>
            <td>2</td>
            <td>+2</td>
        </tr>
        <tr>
            <td>900</td>
            <td>3</td>
            <td>+2</td>
        </tr>
        <tr>
            <td>2,700</td>
            <td>4</td>
            <td>+2</td>
        </tr>
        <tr>
            <td>6,500</td>
            <td>5</td>
            <td>+3</td>
        </tr>
        <tr>
            <td>14,000</td>
            <td>6</td>
            <td>+3</td>
        </tr>
        <tr>
            <td>23,000</td>
            <td>7</td>
            <td>+3</td>
        </tr>
        <tr>
            <td>34,000</td>
            <td>8</td>
            <td>+3</td>
        </tr>
        <tr>
            <td>48,000</td>
            <td>9</td>
            <td>+4</td>
        </tr>
        <tr>
            <td>64,000</td>
            <td>10</td>
            <td>+4</td>
        </tr>
        <tr>
            <td>85,000</td>
            <td>11</td>
            <td>+4</td>
        </tr>
        <tr>
            <td>100,000</td>
            <td>12</td>
            <td>+4</td>
        </tr>
        <tr>
            <td>120,000</td>
            <td>13</td>
            <td>+5</td>
        </tr>
        <tr>
            <td>140,000</td>
            <td>14</td>
            <td>+5</td>
        </tr>
        <tr>
            <td>165,000</td>
            <td>15</td>
            <td>+5</td>
        </tr>
        <tr>
            <td>195,000</td>
            <td>16</td>
            <td>+5</td>
        </tr>
        <tr>
            <td>225,000</td>
            <td>17</td>
            <td>+6</td>
        </tr>
        <tr>
            <td>265,000</td>
            <td>18</td>
            <td>+6</td>
        </tr>
        <tr>
            <td>305,000</td>
            <td>19</td>
            <td>+6</td>
        </tr>
        <tr>
            <td>355,000</td>
            <td>20</td>
            <td>+6<br>
            </td>
        </tr>
        </tbody>
    </table>
    </details>
</div>
</body>


<script>
    const levelData = Array.from(document.querySelectorAll('#levelsTable tbody tr')).map(tr => {
        const [xp, level, proficiencyBonus] = Array.from(tr.querySelectorAll('td')).map(td => parseInt(td.textContent.replace(',', '')));
        return {xp, level, proficiencyBonus}
    });
    const currentLevelElement = document.querySelector('#currentLevel');
    const nextLevelElement = document.querySelector('#nextLevel');
    const percentageElement = document.querySelector('#percentageProgress');
    const progressBar = document.querySelector('#progressBar');

    const epicBoonRate = 30000; // Epic boons every 30,000xp

    const updateScreenForXp = (currentXp) => {
        if(! currentXp || currentXp < 0) {
            return;
        }
        localStorage.setItem('percentage-progress-current-xp', currentXp);

        const lastLevel = levelData[levelData.length - 1];

        if(lastLevel.xp < currentXp) {
            // Level 20 situation
            const xpSince20 = currentXp - lastLevel.xp;
            const numberOfBoons = Math.floor(xpSince20/epicBoonRate);
            const xpSinceLastBoon = xpSince20 % epicBoonRate;
            const percentageProgress = Math.round(( 100 / epicBoonRate ) * xpSinceLastBoon);
            const nextBoonTotalXp = currentXp + epicBoonRate - xpSinceLastBoon;
            currentLevelElement.textContent = '20 & ' + numberOfBoons + ' epic boons';
            nextLevelElement.textContent = '20 & ' + (numberOfBoons + 1) + ' epic boons (' + nextBoonTotalXp.toLocaleString('en') + 'xp)';
            percentageElement.textContent = percentageProgress + '%';
            progressBar.style.width = percentageProgress + '%';
        } else {
            // Normal level situation
            const nextLevel = levelData.find(levelDeets => levelDeets.xp >= currentXp);
            const currentLevel = levelData[levelData.indexOf(nextLevel)-1];
            const percentageProgress = percentage(nextLevel.xp, currentLevel.xp, currentXp);
            currentLevelElement.textContent = currentLevel.level + '';
            nextLevelElement.textContent = nextLevel.level + ' (' + nextLevel.xp.toLocaleString('en') + 'xp)';
            percentageElement.textContent = percentageProgress + '%';
            progressBar.style.width = percentageProgress + '%';
        }
    }

    const currentXpInput = document.querySelector('#currentXp');

    currentXpInput.addEventListener('change', (event) => {
        updateScreenForXp(parseInt( event.target.value.replaceAll(',', '')));
    });

    if(localStorage.getItem('percentage-progress-current-xp')) {
        const currentXpFromStorage = parseInt(localStorage.getItem('percentage-progress-current-xp'));
        currentXpInput.value = currentXpFromStorage.toLocaleString('en');
        updateScreenForXp(currentXpFromStorage);
    }

    function percentage(nextLevelXp, currentLevelXp, currentXp) {
        const xpNeededEntireLevel = nextLevelXp - currentLevelXp;
        const xpAcquiredThisLevel = currentXp - currentLevelXp;
        const percentageThroughLevel = (100 / xpNeededEntireLevel) * xpAcquiredThisLevel;
        return Math.round(percentageThroughLevel);
    }
</script>
</html>